<!DOCTYPE html>
<html lang="pt-BR">
  
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg" href="{{ url_for('static', filename='images/meu-icone.png.svg') }}">
  <title>Resumidor de Texto</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .resumo-box {
      width: 100%;
      height: 400px;
      padding: 20px;
      background-color: #ffffff;
      color: #000000;
      font-family: monospace;
      font-size: 18px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-areas">
      <textarea id="inputTexto" placeholder="| Seu texto"></textarea>
      <div id="outputResumo" class="resumo-box">Resumo aparecerá aqui...</div>
    </div>
    <div class="middle-button">
      <button onclick="resumirTexto()">Resumir →</button>
    </div>
    <div class="file-upload-container">
      <span>OU</span>
      <label for="pdfUpload" class="file-upload-label">
        Envie um PDF
      </label>
      <input type="file" id="pdfUpload" onchange="resumirPDF()" accept=".pdf">
    </div>
    <div class="controls">
      <div class="row">
        <button onclick="setFormato('Parágrafos', this)">Parágrafos</button>
        <button onclick="setFormato('Lista Ordenada', this)">Tópicos</button>
        <button onclick="setFormato('Linha do Tempo', this)">Linha do Tempo</button>
      </div>
      <div class="row">
        <button onclick="setDetalhe('Conciso', this)">Conciso</button>
        <button onclick="setDetalhe('Médio', this)">Médio</button>
        <button onclick="setDetalhe('Detalhado', this)">Detalhado</button>
      </div>
    </div>
  </div>

  <script>
    let formatoSelecionado = 'Parágrafos';
    let detalheSelecionado = 'Médio';


  function setFormato(f, element) {
      formatoSelecionado = f;
      // Remove a classe 'active' de todos os botões de formato
      document.querySelectorAll('.controls .row:nth-child(1) button').forEach(btn => btn.classList.remove('active'));
      // Adiciona a classe 'active' apenas ao botão clicado
      element.classList.add('active');
  }

  function setDetalhe(d, element) {
      detalheSelecionado = d;
      // Remove a classe 'active' de todos os botões de detalhe
      document.querySelectorAll('.controls .row:nth-child(2) button').forEach(btn => btn.classList.remove('active'));
      // Adiciona a classe 'active' apenas ao botão clicado
    element.classList.add('active');
}
    function aplicarNegrito(texto) {
      return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
    }
// Adicione esta função dentro da sua tag <script>
    async function resumirPDF() {
        const fileInput = document.getElementById('pdfUpload');
        const file = fileInput.files[0];

        if (!file) {
            return; // Nenhum ficheiro selecionado
        }

        const outputBox = document.getElementById('outputResumo');
        const uploadLabel = document.querySelector('.file-upload-label');
        const originalLabelText = uploadLabel.innerText;

        // Criar um FormData para enviar o ficheiro e as opções
        const formData = new FormData();
        formData.append('pdf_file', file);
        formData.append('formato', formatoSelecionado);
        formData.append('detalhe', detalheSelecionado);

        // Feedback visual de carregamento
        uploadLabel.innerText = "Enviando...";
        outputBox.innerHTML = "Aguarde, a IA está a ler e a processar o seu PDF...";

        try {
            const response = await fetch('/resumir-pdf', {
                method: 'POST',
                body: formData  // Não definimos 'Content-Type', o navegador faz isso por nós com FormData
            });

            const data = await response.json();

            if (response.ok) {
                const resumoFormatado = aplicarNegrito(data.resumo || "Ocorreu um erro.");
                outputBox.innerHTML = resumoFormatado;
            } else {
                // Se o servidor retornar um erro (ex: formato inválido)
                outputBox.innerText = data.erro || 'Ocorreu um erro desconhecido.';
            }

        } catch (error) {
            console.error("Falha na requisição:", error);
            outputBox.innerHTML = "Não foi possível conectar ao servidor. Por favor, tente novamente.";
        } finally {
            // Restaurar o botão
            uploadLabel.innerText = originalLabelText;
            // Limpar o input para permitir o re-envio do mesmo ficheiro
            fileInput.value = ""; 
        }
    }

    async function resumirTexto() {
        const texto = document.getElementById('inputTexto').value;
        const outputBox = document.getElementById('outputResumo');
        const resumirBtn = document.querySelector('.middle-button button');

        if (!texto.trim()) {
            outputBox.innerText = "Por favor, insira um texto para resumir.";
            return;
        }

        // Desabilitar o botão e mostrar o estado de carregamento
        resumirBtn.disabled = true;
        resumirBtn.innerText = "Resumindo...";
        outputBox.innerHTML = "Aguarde, a IA está a processar o seu pedido...";

        try {
            const response = await fetch('/resumir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto, formato: formatoSelecionado, detalhe: detalheSelecionado })
            });

            // Tratamento de erros do servidor
            if (!response.ok) {
                throw new Error(`Erro do servidor: ${response.statusText}`);
            }

            const data = await response.json();
            const resumoFormatado = aplicarNegrito(data.resumo || "Ocorreu um erro ao gerar o resumo.");
            outputBox.innerHTML = resumoFormatado;

        } catch (error) {
            console.error("Falha na requisição:", error);
            outputBox.innerHTML = "Não foi possível conectar ao servidor. Por favor, tente novamente mais tarde.";
        } finally {
            // Reabilitar o botão, independentemente do resultado
            resumirBtn.disabled = false;
            resumirBtn.innerText = "Resumir →";
        }
    }
  </script>
</body>
</html>
